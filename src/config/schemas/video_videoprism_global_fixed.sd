schema video_videoprism_global {
    document video_videoprism_global {
        field video_id type string {
            indexing: summary | attribute
        }
        field video_title type string {
            indexing: index | summary
            index: enable-bm25
        }
        field creation_timestamp type long {
            indexing: summary | attribute
        }
        field frame_id type int {
            indexing: summary | attribute
        }
        field start_time type float {
            indexing: summary | attribute
        }
        field end_time type float {
            indexing: summary | attribute
        }
        field embedding type tensor<float>(v[768]) {
            indexing: attribute | index
            attribute {
                distance-metric: angular
            }
            index {
                hnsw {
                    max-links-per-node: 16
                    neighbors-to-explore-at-insert: 500
                }
            }
        }
        field embedding_binary type tensor<int8>(v[96]) {
            indexing: attribute
            attribute {
                distance-metric: hamming
            }
        }
    }
    fieldset default {
        fields: video_title
    }
    rank-profile default {
        inputs {
            query(qtb) tensor<int8>(v[96])
        }
        first-phase {
            expression {
                closeness(field, embedding_binary)
            }
        }
    }
    rank-profile bm25_only {
        first-phase {
            expression {
                bm25(video_title)
            }
        }
    }
    rank-profile binary_binary {
        inputs {
            query(qtb) tensor<int8>(v[96])
        }
        first-phase {
            expression {
                closeness(field, embedding_binary)
            }
        }
        match-features {
            distance(field, embedding_binary)
        }
    }
    rank-profile float_float {
        inputs {
            query(qt) tensor<float>(v[768])
        }
        first-phase {
            expression {
                closeness(field, embedding)
            }
        }
    }
    rank-profile float_binary {
        inputs {
            query(qt) tensor<float>(v[768])
        }
        function unpack_binary_representation() {
            expression {
                2*unpack_bits(attribute(embedding_binary)) - 1
            }
        }
        first-phase {
            expression {
                sum(query(qt) * unpack_binary_representation, v)
            }
        }
    }
    rank-profile phased {
        inputs {
            query(qtb) tensor<int8>(v[96])
            query(qt) tensor<float>(v[768])
        }
        function unpack_binary_representation() {
            expression {
                2*unpack_bits(attribute(embedding_binary)) - 1
            }
        }
        first-phase {
            expression {
                closeness(field, embedding_binary)
            }
        }
        second-phase {
            expression {
                sum(query(qt) * unpack_binary_representation, v)
            }
            rerank-count: 100
        }
        match-features {
            distance(field, embedding_binary)
        }
    }
    rank-profile hybrid_float_bm25 {
        inputs {
            query(qt) tensor<float>(v[768])
        }
        function visual_sim() {
            expression {
                closeness(field, embedding)
            }
        }
        function text_sim() {
            expression {
                bm25(video_title)
            }
        }
        first-phase {
            expression {
                visual_sim
            }
        }
        second-phase {
            expression {
                text_sim
            }
            rerank-count: 100
        }
    }
    rank-profile hybrid_binary_bm25 {
        inputs {
            query(qtb) tensor<int8>(v[96])
        }
        function visual_sim() {
            expression {
                closeness(field, embedding_binary)
            }
        }
        function text_sim() {
            expression {
                bm25(video_title)
            }
        }
        first-phase {
            expression {
                visual_sim + 0.1 * text_sim
            }
        }
    }
    rank-profile hybrid_bm25_binary {
        inputs {
            query(qtb) tensor<int8>(v[96])
        }
        function visual_sim() {
            expression {
                closeness(field, embedding_binary)
            }
        }
        function text_sim() {
            expression {
                bm25(video_title)
            }
        }
        first-phase {
            expression {
                text_sim
            }
        }
        second-phase {
            expression {
                visual_sim
            }
            rerank-count: 100
        }
    }
    rank-profile hybrid_bm25_float {
        inputs {
            query(qt) tensor<float>(v[768])
        }
        function visual_sim() {
            expression {
                closeness(field, embedding)
            }
        }
        function text_sim() {
            expression {
                bm25(video_title)
            }
        }
        first-phase {
            expression {
                text_sim
            }
        }
        second-phase {
            expression {
                visual_sim
            }
            rerank-count: 100
        }
    }
}