name: Routing Framework Tests

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - 'src/app/routing/**'
      - 'src/common/**'
      - 'tests/routing/unit/**'
      - 'tests/routing/integration/**'
      - 'configs/config.json'
      - 'pytest.ini'
      - 'pyproject.toml'
      - '.github/workflows/routing-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/app/routing/**'
      - 'src/common/**'
      - 'tests/routing/unit/**'
      - 'tests/routing/integration/**'
      - 'configs/config.json'
      - 'pytest.ini'
      - 'pyproject.toml'

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Cache GLiNER models
      uses: actions/cache@v3
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-gliner-models-v1
        restore-keys: |
          ${{ runner.os }}-gliner-models-
    
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: |
        uv sync --all-extras
        uv pip install pytest-cov
    
    - name: Run routing unit tests
      env:
        COVERAGE_FILE: .coverage
      run: |
        uv run python -m pytest tests/routing/unit -m "unit and not requires_ollama" \
          --cov=src/app/routing \
          --cov-report=term-missing \
          --cov-report=xml:coverage_routing.xml \
          --cov-fail-under=43
        # Debug: Check what files were created
        echo "ðŸ“ Files after test run:"
        ls -la .coverage* 2>/dev/null || echo "No .coverage files found"
        ls -la coverage* 2>/dev/null || echo "No coverage XML files found"
        # Rename the coverage file to avoid conflicts
        if [ -f .coverage ]; then
          echo "âœ… Coverage file found, renaming to .coverage.unit"
          mv .coverage .coverage.unit
        else
          echo "âš ï¸ No .coverage file found - this will affect coverage combining"
        fi
    
    - name: Check coverage files
      run: |
        echo "Checking for coverage files..."
        ls -la .coverage* || true
        ls -la coverage* || true
        echo "Expected file: .coverage.unit"
        [ -f .coverage.unit ] && echo "âœ… Found .coverage.unit" || echo "âŒ Missing .coverage.unit"
    
    - name: Final check before upload
      run: |
        echo "ðŸ” Final file check before artifact upload:"
        echo "Current working directory: $(pwd)"
        echo "GitHub workspace: ${{ github.workspace }}"
        ls -la .coverage* 2>/dev/null || echo "No .coverage* files found"
        ls -la coverage* 2>/dev/null || echo "No coverage* files found"
        echo "Specifically checking for required files:"
        [ -f .coverage.unit ] && echo "âœ… .coverage.unit exists ($(stat -c%s .coverage.unit) bytes)" || echo "âŒ .coverage.unit missing"
        [ -f coverage_routing.xml ] && echo "âœ… coverage_routing.xml exists ($(stat -c%s coverage_routing.xml) bytes)" || echo "âŒ coverage_routing.xml missing"
        echo "Full paths:"
        [ -f ${{ github.workspace }}/.coverage.unit ] && echo "âœ… Full path .coverage.unit exists" || echo "âŒ Full path .coverage.unit missing"
        [ -f ${{ github.workspace }}/coverage_routing.xml ] && echo "âœ… Full path coverage_routing.xml exists" || echo "âŒ Full path coverage_routing.xml missing"
    
    - name: Upload coverage data
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-unit
        path: ${{ github.workspace }}/.coverage.unit
        retention-days: 1
        if-no-files-found: warn
    
    - name: Upload coverage XML
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-unit-xml
        path: ${{ github.workspace }}/coverage_routing.xml
        retention-days: 1
        if-no-files-found: warn


  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: |
        uv sync --all-extras
        uv pip install pytest-cov
    
    - name: Run routing integration tests
      env:
        MOCK_LLM_RESPONSES: "true"
        COVERAGE_FILE: .coverage
      run: |
        # Run routing integration tests from proper directory structure
        uv run python -m pytest tests/routing/integration -m "integration and not local_only" \
          --cov=src/app/routing \
          --cov-report=term-missing \
          --cov-report=xml:coverage_routing_integration.xml
        # Debug: Check what files were created
        echo "ðŸ“ Files after integration test run:"
        ls -la .coverage* 2>/dev/null || echo "No .coverage files found"
        ls -la coverage* 2>/dev/null || echo "No coverage XML files found"
        # Rename the coverage file to avoid conflicts
        if [ -f .coverage ]; then
          echo "âœ… Integration coverage file found, renaming to .coverage.integration"
          mv .coverage .coverage.integration
        else
          echo "âš ï¸ No .coverage file found - this will affect coverage combining"
        fi
    
    - name: Final check before upload
      run: |
        echo "ðŸ” Final file check before artifact upload:"
        echo "Current working directory: $(pwd)"
        echo "GitHub workspace: ${{ github.workspace }}"
        ls -la .coverage* 2>/dev/null || echo "No .coverage* files found"
        ls -la coverage* 2>/dev/null || echo "No coverage* files found"
        echo "Specifically checking for required files:"
        [ -f .coverage.integration ] && echo "âœ… .coverage.integration exists ($(stat -c%s .coverage.integration) bytes)" || echo "âŒ .coverage.integration missing"
        [ -f coverage_routing_integration.xml ] && echo "âœ… coverage_routing_integration.xml exists ($(stat -c%s coverage_routing_integration.xml) bytes)" || echo "âŒ coverage_routing_integration.xml missing"
        echo "Full paths:"
        [ -f ${{ github.workspace }}/.coverage.integration ] && echo "âœ… Full path .coverage.integration exists" || echo "âŒ Full path .coverage.integration missing"
        [ -f ${{ github.workspace }}/coverage_routing_integration.xml ] && echo "âœ… Full path coverage_routing_integration.xml exists" || echo "âŒ Full path coverage_routing_integration.xml missing"
    
    - name: Upload coverage data
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-integration
        path: ${{ github.workspace }}/.coverage.integration
        retention-days: 1
        if-no-files-found: warn
    
    - name: Upload coverage XML
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-integration-xml
        path: ${{ github.workspace }}/coverage_routing_integration.xml
        retention-days: 1
        if-no-files-found: warn

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Install dependencies with dev tools
      run: |
        uv sync --all-extras
    
    - name: Run linting and formatting checks
      run: make lint-routing
      continue-on-error: true

  test-cli:
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Install package
      run: |
        uv sync --all-extras
    
    - name: Test demo script
      run: |
        # Test that the demo script can at least be imported and show help
        uv run python scripts/demo_routing_unified.py --help || echo "Demo script needs CLI args"
    
    - name: Test routing module imports
      run: |
        uv run python -c "from src.app.routing import TieredRouter, ComprehensiveRouter; print('Routing imports successful')"

  coverage-report:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install coverage tool
      run: |
        pip install coverage[toml]
    
    - name: Download unit test coverage
      uses: actions/download-artifact@v4
      with:
        name: coverage-unit
        path: ./coverage-unit/
    
    - name: Download unit test coverage XML
      uses: actions/download-artifact@v4
      with:
        name: coverage-unit-xml
        path: ./coverage-unit-xml/
    
    - name: Download integration test coverage
      uses: actions/download-artifact@v4
      with:
        name: coverage-integration
        path: ./coverage-integration/
    
    - name: Download integration test coverage XML
      uses: actions/download-artifact@v4
      with:
        name: coverage-integration-xml
        path: ./coverage-integration-xml/
    
    - name: Combine coverage data
      run: |
        # Debug: List what artifacts were downloaded
        echo "Contents of coverage-unit:"
        ls -la ./coverage-unit/ || echo "coverage-unit directory not found"
        echo "Contents of coverage-unit-xml:"
        ls -la ./coverage-unit-xml/ || echo "coverage-unit-xml directory not found"
        echo "Contents of coverage-integration:"
        ls -la ./coverage-integration/ || echo "coverage-integration directory not found"
        echo "Contents of coverage-integration-xml:"
        ls -la ./coverage-integration-xml/ || echo "coverage-integration-xml directory not found"
        
        # Copy coverage files with unique names
        mkdir -p combined-coverage
        has_coverage=false
        
        # Look for unit coverage file (uploaded as single file, so should be directly accessible)
        if [ -f ./coverage-unit/.coverage.unit ]; then
          cp ./coverage-unit/.coverage.unit combined-coverage/.coverage.unit
          echo "âœ… Copied unit coverage"
          has_coverage=true
        elif [ -f ./coverage-unit/.coverage ]; then
          cp ./coverage-unit/.coverage combined-coverage/.coverage.unit
          echo "âœ… Copied unit coverage (found as .coverage)"
          has_coverage=true
        else
          echo "âŒ No unit .coverage file found"
          echo "Available files in coverage-unit:"
          find ./coverage-unit/ -type f 2>/dev/null || echo "No files found"
        fi
        
        # Look for integration coverage file
        if [ -f ./coverage-integration/.coverage.integration ]; then
          cp ./coverage-integration/.coverage.integration combined-coverage/.coverage.integration
          echo "âœ… Copied integration coverage"
          has_coverage=true
        elif [ -f ./coverage-integration/.coverage ]; then
          cp ./coverage-integration/.coverage combined-coverage/.coverage.integration
          echo "âœ… Copied integration coverage (found as .coverage)"
          has_coverage=true
        else
          echo "âŒ No integration .coverage file found"
          echo "Available files in coverage-integration:"
          find ./coverage-integration/ -type f 2>/dev/null || echo "No files found"
        fi
        
        # Only combine if we have coverage files
        if [ "$has_coverage" = true ]; then
          cd combined-coverage
          ls -la .coverage.*
          coverage combine .coverage.*
        else
          echo "âš ï¸ No coverage files to combine, skipping"
          mkdir -p combined-coverage
          cd combined-coverage
          # Create empty coverage file so later steps don't fail
          echo "No coverage data available" > coverage-combined.xml
        fi
        
        # Generate reports only if we have coverage data
        if [ "$has_coverage" = true ]; then
          echo "ðŸ“Š Generating coverage reports..."
          coverage report --show-missing
          coverage xml -o coverage-combined.xml
          coverage html -d htmlcov-combined
          
          echo "## Routing Module Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          coverage report >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No coverage data to report" >> $GITHUB_STEP_SUMMARY
          # Create dummy files so upload doesn't fail
          mkdir -p htmlcov-combined
          echo "<html><body>No coverage data available</body></html>" > htmlcov-combined/index.html
        fi
    
    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      with:
        name: routing-coverage-report
        path: combined-coverage/htmlcov-combined/